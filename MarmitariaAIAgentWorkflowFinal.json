{
  "name": "Marmitaria AI Agent Workflow",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "5f40d36e-1e5a-4abc-9649-55ee1e6e39b6",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        784,
        224
      ],
      "webhookId": "971b30db-3f91-489f-a477-cee9f78f8e3e",
      "credentials": {
        "telegramApi": {
          "id": "rgh5F5REK8irWEM5",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "56587c9a-6613-4b69-891f-1136724a1006",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        1200,
        320
      ],
      "credentials": {
        "openAiApi": {
          "id": "9y92klWbK76V90Tg",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionKey": "={{ $json.message.chat.id }}"
      },
      "id": "d63a32c5-bf57-41e5-a8e8-520a2286e2bf",
      "name": "Redis Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1216,
        512
      ],
      "credentials": {
        "redis": {
          "id": "g1wZADzxSwcOmxjS",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Busca o cardÃ¡pio completo com todos os produtos disponÃ­veis, suas descriÃ§Ãµes e preÃ§os. Use esta ferramenta quando o cliente pedir para ver o cardÃ¡pio ou iniciar a conversa.",
        "operation": "executeQuery",
        "query": "SELECT id, name, description, base_price FROM products WHERE active = true ORDER BY name",
        "options": {}
      },
      "id": "581c0183-4aa6-4eaa-beb0-9c7cd05af107",
      "name": "Get Menu Items Tool",
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1392,
        464
      ],
      "credentials": {
        "postgres": {
          "id": "4CceWD58AvkJkHMZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "description": "Receives product IDs and paid addition IDs from AI to calculate order total. The AI determines which products and paid additions are in the order based on the conversation context.",
        "jsCode": "const productIds = $fromAI('product_ids', 'Array of product IDs - send as array of numbers like [1,2,3]', 'json', []); const paidAdditionIds = $fromAI('paid_addition_ids', 'Array of paid addition IDs - send as array of numbers like [5,6]', 'json', []); const extractIds = (arr) => { if (!Array.isArray(arr)) return []; return arr.map(item => typeof item === 'object' && item.id ? item.id : item); }; const cleanProductIds = extractIds(productIds); const cleanPaidAdditionIds = extractIds(paidAdditionIds); return `Received ${cleanProductIds.length} products (IDs: ${cleanProductIds.join(',')}) and ${cleanPaidAdditionIds.length} paid additions (IDs: ${cleanPaidAdditionIds.join(',')}). Use Get Menu Items and Get Paid Additions tools to query prices from database and calculate total.`;"
      },
      "id": "8ff86e80-043d-4315-ac4a-56649977607c",
      "name": "Calculate Order Total Tool",
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        1648,
        464
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $('Process JSON').item.json.customer_message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "78967e65-bcfa-4f69-a3ab-dac7a502465a",
      "name": "Send Telegram Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2432,
        208
      ],
      "webhookId": "c6a6f465-f065-4a45-a4fa-e9679a6ffb29",
      "credentials": {
        "telegramApi": {
          "id": "rgh5F5REK8irWEM5",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $input.first().json;\n\nlet parsedData;\nlet rawText = '';\n\nif (agentOutput.text && Array.isArray(agentOutput.text)) {\n  rawText = agentOutput.text[0]?.text || agentOutput.text[0] || '';\n} else if (typeof agentOutput.output === 'string') {\n  rawText = agentOutput.output;\n} else if (agentOutput.order_confirmed !== undefined) {\n  parsedData = agentOutput;\n}\n\nif (!parsedData && rawText) {\n  const jsonMatch = rawText.match(/\\{[\\s\\S]*?\\}(?=\\s*(?:\\{|$))/);\n\n  if (jsonMatch) {\n    let cleanJson = jsonMatch[0];\n    \n    const firstObjectEnd = cleanJson.lastIndexOf('}');\n    if (firstObjectEnd !== -1) {\n      cleanJson = cleanJson.substring(0, firstObjectEnd + 1);\n    }\n    \n    try {\n      parsedData = JSON.parse(cleanJson);\n    } catch (e) {\n      let braceCount = 0;\n      let jsonStart = -1;\n      let jsonEnd = -1;\n      \n      for (let i = 0; i < rawText.length; i++) {\n        if (rawText[i] === '{') {\n          if (braceCount === 0) jsonStart = i;\n          braceCount++;\n        } else if (rawText[i] === '}') {\n          braceCount--;\n          if (braceCount === 0 && jsonStart !== -1) {\n            jsonEnd = i;\n            break;\n          }\n        }\n      }\n      \n      if (jsonStart !== -1 && jsonEnd !== -1) {\n        try {\n          parsedData = JSON.parse(rawText.substring(jsonStart, jsonEnd + 1));\n        } catch (e2) {\n          parsedData = {\n            order_confirmed: false,\n            items: [],\n            paid_additions: [],\n            removed_ingredients: [],\n            total_price: 0,\n            customer_message: rawText\n          };\n        }\n      } else {\n        parsedData = {\n          order_confirmed: false,\n          items: [],\n          paid_additions: [],\n          removed_ingredients: [],\n          total_price: 0,\n          customer_message: rawText\n        };\n      }\n    }\n  } else {\n    parsedData = {\n      order_confirmed: false,\n      items: [],\n      paid_additions: [],\n      removed_ingredients: [],\n      total_price: 0,\n      customer_message: rawText\n    };\n  }\n}\n\nparsedData.items ||= [];\nparsedData.paid_additions ||= [];\nparsedData.removed_ingredients ||= [];\nparsedData.total_price ||= 0;\nparsedData.customer_message ||= 'Erro ao processar resposta';\n\nif (parsedData.order_confirmed === true) {\n  const orderData = {\n    items: parsedData.items,\n    paid_additions: parsedData.paid_additions,\n    removed_ingredients: parsedData.removed_ingredients,\n    total_price: parsedData.total_price,\n    customer_message: parsedData.customer_message\n  };\n\n  const orderDetailsJson = JSON.stringify({\n    items: orderData.items,\n    paid_additions: orderData.paid_additions,\n    removed_ingredients: orderData.removed_ingredients\n  });\n\n  return {\n    json: {\n      order_details: orderDetailsJson,\n      total_price: orderData.total_price,\n      status: 'confirmed',\n      customer_message: orderData.customer_message,\n      message: $('Telegram Trigger').first().json.message\n    }\n  };\n} else {\n  return {\n    json: {\n      skip_save: true,\n      customer_message: parsedData.customer_message,\n      message: $('Telegram Trigger').first().json.message\n    }\n  };\n}\n"
      },
      "id": "4df0b602-39aa-4f5f-92fb-ba808dee993c",
      "name": "Process JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1744,
        192
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3f7e3b6d-8469-4e4e-b229-433ab35e425d",
              "name": "sessionId",
              "value": "=={{ $json[\"message\"][\"chat\"][\"id\"] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1008,
        224
      ],
      "id": "d2cb7718-d40f-4014-9c2a-b78e5f8e56dc",
      "name": "Set Session Id"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Busca todos os adicionais pagos (extras) disponÃ­veis que podem ser adicionados Ã s marmitas, com nomes e preÃ§os. Use quando discutir personalizaÃ§Ãµes.",
        "operation": "executeQuery",
        "query": "SELECT id, name, additional_price FROM ingredients WHERE is_paid_addition = true ORDER BY name",
        "options": {}
      },
      "id": "780f7080-51a5-49b2-9ef0-7c77487a4d4e",
      "name": "Get Paid Additions Tool",
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1520,
        432
      ],
      "credentials": {
        "postgres": {
          "id": "4CceWD58AvkJkHMZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "mode": "name",
          "value": "orders"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "customer_chat_id": "={{ $json.message.chat.id }}",
            "order_details": "={{ $json.order_details }}",
            "total_price": "={{ $json.total_price }}",
            "status": "={{ $json.status }}",
            "created_at": "={{ $now }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "customer_chat_id",
              "displayName": "customer_chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "order_details",
              "displayName": "order_details",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "total_price",
              "displayName": "total_price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "9b1c5e07-c8ee-4e5d-b6cc-1d397ad270fc",
      "name": "Save Order",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2176,
        96
      ],
      "credentials": {
        "postgres": {
          "id": "4CceWD58AvkJkHMZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.skip_save }}",
              "operator": {
                "type": "string",
                "operation": "notExists"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "97f2e259-768b-4f33-a90b-0fbe4907db04",
      "name": "Check Confimation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1952,
        192
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Telegram Trigger').item.json.message.text }}",
        "options": {
          "systemMessage": "VocÃª Ã© um assistente de IA amigÃ¡vel para uma marmitaria brasileira.\n\nSeu papel Ã© ajudar o cliente a:\n- Atende-lo de forma agradÃ¡vel e humana\n- Ver o cardÃ¡pio completo chamando a ferramenta get_menu_items quando o cliente requisitar o cardapio.\n- Ver adicionais pagos disponÃ­veis chamando get_paid_additions\n- Criar pedidos personalizados (adicionar extras pagos, remover ingredientes)\n- Calcular o preÃ§o total incluindo adicionais\n- Confirmar o pedido final\n\nExemplo de primeira mensagem:\n\"OlÃ¡! Bem-vindo Ã  nossa marmitaria. Gostaria de ver o nosso cardÃ¡pio?\"\n\nDiretrizes importantes!\n- Inicie a conversa sempre com uma mensagem de boas-vindas, educada, perguntando se o cliente deseja ver o cardÃ¡pio!\n- NÃ£o envie o cardÃ¡pio automaticamente, apenas se o cliente solicitar.\n- Sempre mostre o cardÃ¡pio completo quando o cliente pedir.\n- Liste todos os produtos retornados por get_menu_items.\n- Apresente cada produto com: nome, descriÃ§Ã£o e preÃ§o.\n- Mostre adicionais pagos ao discutir personalizaÃ§Ãµes.\n- Remover ingredientes nÃ£o reduz o preÃ§o.\n- Adicionais pagos aumentam o preÃ§o.\n- Confirme o pedido completo com o preÃ§o final antes de finalizar.\n- Seja sempre educado, acolhedor e prestativo.\n- Fale sempre em portuguÃªs brasileiro.\n\n=== FORMATO DE RESPOSTA OBRIGATÃ“RIO ===\n\nâš ï¸ REGRAS CRÃTICAS DE FORMATAÃ‡ÃƒO JSON:\n1. RETORNE EXATAMENTE UM (1) OBJETO JSON - NUNCA MAIS DE UM\n2. NÃƒO ADICIONE TEXTO ANTES OU DEPOIS DO JSON\n3. NÃƒO DUPLIQUE O OBJETO JSON (ERRO COMUM: ENVIAR O MESMO JSON DUAS VEZES)\n4. TODOS OS CAMPOS SÃƒO OBRIGATÃ“RIOS - NUNCA OMITA NENHUM CAMPO\n5. USE APENAS ASPAS DUPLAS (\") PARA STRINGS\n6. GARANTA QUE O JSON SEJA VÃLIDO E BEM FORMATADO\n7. NÃƒO ADICIONE COMENTÃRIOS OU EXPLICAÃ‡Ã•ES FORA DO JSON\n8. SE VOCÃŠ GERAR DOIS OBJETOS JSON, ESTÃ ERRADO - DELETE UM E MANTENHA APENAS UM\n\nDurante a conversa (antes da confirmaÃ§Ã£o):\n{\n  \"order_confirmed\": false,\n  \"items\": [],\n  \"paid_additions\": [],\n  \"removed_ingredients\": [],\n  \"total_price\": 0,\n  \"customer_message\": \"Sua resposta em portuguÃªs aqui\"\n}\n\nQuando o cliente confirmar o pedido:\n{\n  \"order_confirmed\": true,\n  \"items\": [{\"id\": 1, \"name\": \"Nome do Produto\"}],\n  \"paid_additions\": [{\"id\": 11, \"name\": \"Ovo frito\", \"price\": 2.00}],\n  \"removed_ingredients\": [\"Salada\"],\n  \"total_price\": 20.00,\n  \"customer_message\": \"Pedido confirmado! Sua Marmita Executiva com ovo frito (sem salada) ficou em R$ 20,00. Obrigado!\"\n}\n\nâœ… EXEMPLO DE RESPOSTA CORRETA (UM ÃšNICO OBJETO):\n{\n  \"order_confirmed\": false,\n  \"items\": [],\n  \"paid_additions\": [],\n  \"removed_ingredients\": [],\n  \"total_price\": 0,\n  \"customer_message\": \"OlÃ¡! Bem-vindo Ã  nossa marmitaria. Gostaria de ver o cardÃ¡pio?\"\n}\n\nâŒ EXEMPLO DE RESPOSTA INCORRETA - NUNCA FAÃ‡A ISSO (DOIS OBJETOS DUPLICADOS):\n{\n  \"order_confirmed\": false,\n  \"items\": [],\n  \"paid_additions\": [],\n  \"removed_ingredients\": [],\n  \"total_price\": 0,\n  \"customer_message\": \"OlÃ¡!\"\n}\n{\n  \"order_confirmed\": false,\n  \"items\": [],\n  \"paid_additions\": [],\n  \"removed_ingredients\": [],\n  \"total_price\": 0,\n  \"customer_message\": \"Bem-vindo!\"\n}\n\nâš ï¸ ATENÃ‡ÃƒO: O EXEMPLO ACIMA COM DOIS OBJETOS JSON Ã‰ PROIBIDO E CAUSARÃ ERRO NO SISTEMA!\n\n=== LEMBRETE FINAL ===\n- Retorne SOMENTE UM (1) objeto JSON por resposta\n- NUNCA retorne dois ou mais objetos JSON\n- SEMPRE inclua todos os campos obrigatÃ³rios no Ãºnico objeto\n- Todas as mensagens ao cliente devem ir dentro de customer_message do Ãºnico objeto\n- Quando for requisitado o cardapio inclua ele formatado ao texto do customer_message\n- Conte quantas vezes vocÃª abriu '{' e fechou '}' no nÃ­vel raiz - deve ser exatamente uma vez cada"
        }
      },
      "id": "ebf0bd8f-cf05-4f47-9e4a-4d38264c3af5",
      "name": "Marmitaria AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1376,
        192
      ]
    },
    {
      "parameters": {
        "content": "# WORKFLOW: Sistema de Pedidos de Marmitaria via Telegram\n\n## Objetivo\nAutomaÃ§Ã£o completa de atendimento ao cliente via Telegram bot com IA, permitindo:\n- Consulta de cardÃ¡pio\n- VisualizaÃ§Ã£o de ingredientes\n- PersonalizaÃ§Ã£o de pedidos (adicionais pagos e remoÃ§Ãµes)\n- CÃ¡lculo automÃ¡tico de preÃ§os\n- ConfirmaÃ§Ã£o e salvamento de pedidos\n\n## Fluxo Principal\n1. Cliente envia mensagem no Telegram\n2. IA processa com contexto de conversa (Redis)\n3. IA usa ferramentas para consultar banco de dados\n4. Resposta formatada em JSON\n5. Pedido confirmado Ã© salvo no PostgreSQL\n6. Cliente recebe confirmaÃ§Ã£o via Telegram\n\n## Tecnologias\n- **Telegram Bot**: Interface com cliente\n- **OpenAI GPT-4**: Processamento de linguagem natural\n- **Redis**: MemÃ³ria de conversaÃ§Ã£o\n- **PostgreSQL**: Banco de dados (produtos, ingredientes, pedidos)",
        "height": 780,
        "width": 448
      },
      "id": "13c947a7-79c5-4b2f-ace4-27dc9843ec35",
      "name": "ðŸ“‹ VISÃƒO GERAL DO WORKFLOW",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        240,
        -96
      ]
    },
    {
      "parameters": {
        "content": "# TOOLS\n\n## Ferramentas DisponÃ­veis\n\n### 1. Get Menu Items Tool\n- Lista todos os produtos ativos\n- Retorna: id, nome, descriÃ§Ã£o, preÃ§o base\n\n### 2. Get Paid Additions Tool\n- Lista todos os extras disponÃ­veis\n- Retorna: id, nome, preÃ§o adicional\n\n### 3. Calculate Order Total Tool\n- Calcula preÃ§o total do pedido\n- ParÃ¢metros: product_ids[], paid_addition_ids[]\n- Usa $fromAI() para receber dados dinamicamente",
        "height": 468,
        "width": 388,
        "color": 6
      },
      "id": "190a322a-a0e3-4ac1-8ef7-0517b97a8f9e",
      "name": "ðŸ¤– AI AGENT & TOOLS",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1360,
        624
      ]
    },
    {
      "parameters": {
        "content": "# PROCESSAMENTO & LÃ“GICA\n\n## Set Session Id\n- Extrai chat.id do Telegram\n- Usado como chave de sessÃ£o no Redis\n- Garante memÃ³ria isolada por cliente\n\n## Process JSON\n- **Entrada**: Output do AI Agent (mÃºltiplos formatos)\n- **Processamento**:\n  - Detecta formato (text array, output string, JSON direto)\n  - Faz parsing com tratamento de erros\n  - Extrai campos: order_confirmed, items, paid_additions, removed_ingredients, total_price, customer_message\n- **SaÃ­da para pedido confirmado**:\n  - order_details (JSON string)\n  - total_price\n  - status: \"confirmed\"\n  - customer_message\n- **SaÃ­da para conversa**:\n  - skip_save: true\n  - customer_message\n\n## Check Confirmation\n- Verifica se campo skip_save existe\n- **Rota TRUE**: Pedido confirmado â†’ Save Order\n- **Rota FALSE**: Apenas conversa â†’ Send Response",
        "height": 804,
        "width": 420,
        "color": 2
      },
      "id": "db4ad89e-4e3b-4e25-8324-628c990f98dd",
      "name": "âš™ï¸ PROCESSAMENTO & LÃ“GICA",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        736,
        384
      ]
    },
    {
      "parameters": {
        "content": "# BANCO DE DADOS\n\n## PostgreSQL\n\n### Tabela: products\n- id, name, description, base_price, active\n- Armazena cardÃ¡pio da marmitaria\n\n### Tabela: ingredients\n- id, name, is_paid_addition, additional_price\n- Ingredientes base e adicionais pagos\n\n### Tabela: orders\n- id, customer_chat_id, order_details, total_price, status, created_at\n- **customer_chat_id**: ID do chat do Telegram\n- **order_details**: JSON com items, paid_additions, removed_ingredients\n- **total_price**: Valor total calculado\n- **status**: \"confirmed\"\n- **created_at**: Timestamp da criaÃ§Ã£o\n\n## Save Order Node\n- Insere pedido confirmado na tabela orders\n- Usa expressÃµes para mapear campos do Process JSON",
        "height": 676,
        "width": 372,
        "color": 4
      },
      "id": "d7ab2f41-530d-4761-be08-beeb4e245f34",
      "name": "ðŸ’¾ PERSISTÃŠNCIA DE DADOS",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1792,
        416
      ]
    },
    {
      "parameters": {
        "content": "# ENTRADA\n\n## Telegram Trigger\n- **Tipo**: Webhook\n- **Evento**: Mensagens recebidas\n- **Output**: Objeto completo da mensagem do Telegram\n- **Campos importantes**:\n  - message.text: Texto enviado pelo cliente\n  - message.chat.id: Identificador Ãºnico do chat",
        "height": 288,
        "width": 432,
        "color": 5
      },
      "id": "eadd8737-ddba-4644-9b9f-86a85fda9fdf",
      "name": "ðŸ“± ENTRADA & SAÃDA",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        736,
        -96
      ]
    },
    {
      "parameters": {
        "content": "# SAÃDA\n\n## Send Telegram Response\n- **Tipo**: AÃ§Ã£o\n- **OperaÃ§Ã£o**: Enviar mensagem\n- **Chat ID**: ExtraÃ­do do trigger original\n- **Texto**: Campo customer_message do Process JSON\n- **ConfiguraÃ§Ã£o**: appendAttribution = false (sem assinatura n8n)\n\n## Formato de Resposta JSON\n\n### Durante conversa:\n```json\n{\n  \"order_confirmed\": false,\n  \"items\": [],\n  \"paid_additions\": [],\n  \"removed_ingredients\": [],\n  \"total_price\": 0,\n  \"customer_message\": \"Mensagem que serÃ¡ enviada ao usuÃ¡rio\"\n}\n```\n\n### Pedido confirmado:\n```json\n{\n  \"order_confirmed\": true,\n  \"items\": [{\"id\": 1, \"name\": \"Marmita X\"}],\n  \"paid_additions\": [{\"id\": 5, \"name\": \"Ovo\", \"price\": 2.0}],\n  \"removed_ingredients\": [\"Salada\"],\n  \"total_price\": 20.0,\n  \"customer_message\": \"Pedido confirmado!\"\n}\n```",
        "height": 768,
        "width": 608,
        "color": 3
      },
      "id": "5ed2f066-7288-44a5-980c-cc1d8e754fd4",
      "name": "ðŸ“± ENTRADA & SAÃDA1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2192,
        384
      ]
    },
    {
      "parameters": {
        "content": "# AI AGENT\n\n## Marmitaria AI Agent\n- **Modelo**: OpenAI GPT-4.1-mini\n- **FunÃ§Ã£o**: Orquestrador principal da conversa\n- **SaÃ­da**: JSON estruturado com dados do pedido\n- **MemÃ³ria**: Redis",
        "height": 244,
        "width": 420,
        "color": 7
      },
      "id": "8a032705-6958-4852-bb0f-37f2ed79ae37",
      "name": "ðŸ¤– AI AGENT & TOOLS1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1264,
        -80
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Set Session Id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Marmitaria AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Marmitaria AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Get Menu Items Tool": {
      "ai_tool": [
        [
          {
            "node": "Marmitaria AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Order Total Tool": {
      "ai_tool": [
        [
          {
            "node": "Marmitaria AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Process JSON": {
      "main": [
        [
          {
            "node": "Check Confimation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Session Id": {
      "main": [
        [
          {
            "node": "Marmitaria AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Paid Additions Tool": {
      "ai_tool": [
        [
          {
            "node": "Marmitaria AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Save Order": {
      "main": [
        [
          {
            "node": "Send Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Confimation": {
      "main": [
        [
          {
            "node": "Save Order",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marmitaria AI Agent": {
      "main": [
        [
          {
            "node": "Process JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "fe26f964-20e2-4f18-ac97-f58f804836b2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a82de961fc78ad34d89f0a4ccc918e3afd9bb063993058c3af2996a4a39657e4"
  },
  "id": "I7unWWzfLbmyJzHE",
  "tags": []
}